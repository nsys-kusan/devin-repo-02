# 基本設計書

## 目次
1. 概要 (Overview)
2. システム構成 (System Architecture Overview)
3. データベース概要 (Database Overview)
4. API概要 (API Overview)
5. フロントエンド概要 (Frontend Overview)
6. CI/CDとデプロイ (CI/CD and Deployment)
7. メンテナンスや将来の拡張 (Future Enhancements)

## 1. 概要

本プロジェクトは、FastAPIとReactを使用したフルスタック型Webアプリケーションテンプレートです。マイクロサービスアーキテクチャを採用し、Docker Composeによる開発・本番環境の統一的な管理を実現しています。

### 1.1 主要機能
- ユーザー認証・認可システム（JWT認証）
- アイテム管理システム（CRUD操作）
- メール通知システム
- 管理者向け特権機能
- 多言語対応（i18n）

### 1.2 使用技術
#### バックエンド
- FastAPI (Python)
- SQLModel (ORM)
- PostgreSQL
- Alembic (マイグレーション)
- pytest (テスト)

#### フロントエンド
- React
- TypeScript
- Chakra UI
- Playwright (E2Eテスト)

#### インフラストラクチャ
- Docker & Docker Compose
- Traefik (リバースプロキシ)
- GitHub Actions (CI/CD)
- MailCatcher (開発環境用メールサーバー)

### 1.3 ディレクトリ構造
```
/
├── backend/
│   ├── app/
│   │   ├── api/        - APIエンドポイント
│   │   ├── core/       - 設定・セキュリティ
│   │   ├── models.py   - データモデル
│   │   └── tests/      - テストコード
│   └── scripts/        - ユーティリティスクリプト
├── frontend/
│   ├── src/
│   │   ├── components/ - Reactコンポーネント
│   │   ├── routes/     - ルーティング
│   │   └── client/     - API Client
│   └── tests/          - E2Eテスト
└── docs/               - ドキュメント
```

### 1.4 主要設定ファイル
- `.env`: 環境変数設定
- `docker-compose.yml`: 基本サービス構成
- `docker-compose.override.yml`: 開発環境用オーバーライド
- `docker-compose.traefik.yml`: Traefik設定（本番環境用）
- `pyproject.toml`: Pythonプロジェクト設定
- `package.json`: Node.jsプロジェクト設定

## 2. システム構成

本システムは、マイクロサービスアーキテクチャに基づく複数のコンテナで構成されています。各コンポーネントは独立して開発・デプロイが可能で、Docker Composeによって統合的に管理されています。

### 2.1 アーキテクチャ概要
```
[クライアント] → [Traefik] → [Frontend(React)] → [Backend(FastAPI)] → [PostgreSQL]
                     ↓             ↓                      ↓
                  HTTPS        API Client          Email Service
                  証明書        自動生成         (MailCatcher)
```

### 2.2 コンポーネント詳細

#### 2.2.1 Traefik (リバースプロキシ)
- 役割：HTTPSターミネーション、ルーティング、ロードバランシング
- 設定：`docker-compose.traefik.yml`
- 機能：
  - 自動HTTPS証明書管理
  - サービスディスカバリ
  - ヘルスチェック

#### 2.2.2 フロントエンド (React)
- 役割：ユーザーインターフェース、状態管理
- 主要ファイル：`/frontend/src/`
- 機能：
  - SPA (Single Page Application)
  - JWT認証統合
  - 自動生成APIクライアント
  - レスポンシブデザイン

#### 2.2.3 バックエンド (FastAPI)
- 役割：ビジネスロジック、認証、データアクセス
- 主要ファイル：`/backend/app/`
- 機能：
  - RESTful API
  - JWT認証・認可
  - OpenAPI (Swagger) ドキュメント
  - 非同期処理対応

#### 2.2.4 データベース (PostgreSQL)
- 役割：永続化ストレージ
- 設定：環境変数による接続管理
- 機能：
  - SQLModel ORM統合
  - マイグレーション管理
  - バックアップ・リストア

#### 2.2.5 メールサービス
- 開発環境：MailCatcher
- 本番環境：SMTP設定による外部メールサービス
- 機能：
  - パスワードリセット
  - 通知メール
  - HTML/テキストメール対応

### 2.3 セキュリティ設計
- JWT（JSON Web Token）による認証
- パスワードのハッシュ化（bcrypt）
- CORS設定によるクロスオリジン制御
- 環境変数による機密情報管理
- HTTPSによる通信暗号化

### 2.4 開発環境構成
```bash
# 開発環境起動
docker compose up -d

# フロントエンド開発サーバー
http://dashboard.localhost.tiangolo.com

# バックエンドAPI
http://api.localhost.tiangolo.com

# API ドキュメント
http://api.localhost.tiangolo.com/docs

# メールキャッチャー
http://localhost:8025
```

### 2.5 本番環境構成
- Traefikによる自動HTTPS対応
- 環境変数による設定管理
- スケーラブルなコンテナ構成
- バックアップ・リストア手順
- ヘルスチェックとモニタリング

## 3. データベース概要

本システムは、PostgreSQLをデータベースとして採用し、SQLModelを使用してPythonネイティブなデータモデリングを実現しています。

### 3.1 SQLModelの特徴
- SQLAlchemyとPydanticの統合
- 型安全なデータモデリング
- 自動バリデーション
- OpenAPI（Swagger）との連携

#### 3.1.1 主要モデル定義例
```python
# /backend/app/models.py
class UserBase(SQLModel):
    email: EmailStr = Field(unique=True, index=True, max_length=255)
    full_name: str = Field(index=True, max_length=255)
    is_active: bool = True
    is_superuser: bool = False

class ItemBase(SQLModel):
    title: str = Field(min_length=1, max_length=255)
    description: str | None = Field(default=None)
    owner_id: UUID = Field(foreign_key="user.id")
```

### 3.2 データベース設計
#### 3.2.1 テーブル構成
- users: ユーザー情報管理
- items: アイテムデータ管理
- relationships: リレーション管理

#### 3.2.2 インデックス設計
- email (users): ユニーク制約付きインデックス
- full_name (users): 検索用インデックス
- owner_id (items): 外部キー制約付きインデックス

### 3.3 Alembicマイグレーション
#### 3.3.1 マイグレーション管理
- 場所: `/backend/app/alembic/`
- バージョン管理されたスキーマ変更
- ロールバック対応

#### 3.3.2 主要コマンド
```bash
# マイグレーション生成
alembic revision --autogenerate -m "description"

# マイグレーション適用
alembic upgrade head

# ロールバック
alembic downgrade -1
```

### 3.4 データベース操作
#### 3.4.1 CRUD操作
- 場所: `/backend/app/crud.py`
- 非同期処理対応
- トランザクション管理
- バルク操作最適化

#### 3.4.2 接続管理
- 環境変数による設定
  - `POSTGRES_SERVER`
  - `POSTGRES_USER`
  - `POSTGRES_PASSWORD`
  - `POSTGRES_DB`
- コネクションプール最適化
- 自動再接続機能

### 3.5 バックアップと復元
- 定期バックアップ設定
- ポイントインタイムリカバリ
- データ整合性チェック

### 3.6 パフォーマンス最適化
- インデックス最適化
- クエリパフォーマンスモニタリング
- N+1問題の回避
- キャッシュ戦略

## 4. API概要

本システムのAPIは、FastAPIフレームワークを使用して実装されています。OpenAPI（Swagger）仕様に準拠し、自動的にAPIドキュメントが生成されます。

### 4.1 主要エンドポイント
#### 4.1.1 認証関連
```
POST   /api/v1/login/access-token      # JWTトークン取得
POST   /api/v1/login/test-token        # トークン検証
POST   /api/v1/password-recovery/{email} # パスワードリセット
```

#### 4.1.2 ユーザー管理
```
GET    /api/v1/users/                  # ユーザー一覧取得
POST   /api/v1/users/                  # ユーザー作成
GET    /api/v1/users/{user_id}         # ユーザー詳細取得
PUT    /api/v1/users/{user_id}         # ユーザー情報更新
DELETE /api/v1/users/{user_id}         # ユーザー削除
```

#### 4.1.3 アイテム管理
```
GET    /api/v1/items/                  # アイテム一覧取得
POST   /api/v1/items/                  # アイテム作成
GET    /api/v1/items/{item_id}         # アイテム詳細取得
PUT    /api/v1/items/{item_id}         # アイテム更新
DELETE /api/v1/items/{item_id}         # アイテム削除
```

### 4.2 認証・認可システム
#### 4.2.1 JWT認証
- トークン生成: `/backend/app/core/security.py`
- 有効期限管理
- リフレッシュトークン対応

#### 4.2.2 権限管理
- スーパーユーザー権限
- オーナー権限（アイテム管理）
- アクティブユーザー判定

### 4.3 APIレスポンス形式
```json
{
    "data": {},      // レスポンスデータ
    "message": "",   // メッセージ
    "status": 200    // ステータスコード
}
```

### 4.4 エラーハンドリング
- HTTPException対応
- カスタムエラーレスポンス
- バリデーションエラー処理

### 4.5 API実装場所
- ルート定義: `/backend/app/api/routes/`
- 依存関係: `/backend/app/api/deps.py`
- スキーマ: `/backend/app/schemas/`
- CRUD操作: `/backend/app/crud.py`

### 4.6 APIドキュメント
- Swagger UI: `/docs`
- ReDoc: `/redoc`
- OpenAPI仕様: `/openapi.json`

### 4.7 APIクライアント
- 自動生成TypeScriptクライアント
- 型安全なAPI呼び出し
- エラーハンドリング統合

### 4.8 セキュリティ対策
- CORS設定
- レート制限
- APIキーバリデーション
- 入力サニタイズ

### 4.9 パフォーマンス最適化
- キャッシュ制御
- 非同期処理
- バッチ処理対応
- クエリ最適化

## 5. フロントエンド概要

本システムのフロントエンドは、React、TypeScript、Chakra UIを使用したモダンなSingle Page Application（SPA）として実装されています。

### 5.1 技術スタック
- React 18
- TypeScript
- Chakra UI（UIコンポーネント）
- React Router（ルーティング）
- React Query（状態管理）
- React Hook Form（フォーム管理）
- Playwright（E2Eテスト）

### 5.2 ディレクトリ構造
```
/frontend/
├── src/
│   ├── components/     - 再利用可能なUIコンポーネント
│   ├── routes/         - ページコンポーネントとルーティング
│   ├── hooks/          - カスタムフック
│   ├── utils/          - ユーティリティ関数
│   ├── client/         - 自動生成APIクライアント
│   └── i18n/           - 多言語化リソース
├── tests/              - E2Eテスト
└── public/             - 静的アセット
```

### 5.3 主要コンポーネント
#### 5.3.1 認証関連
- LoginForm: ログインフォーム
- PasswordResetForm: パスワードリセット
- ProtectedRoute: 認証必須ルート

#### 5.3.2 ユーザー管理
- UserList: ユーザー一覧表示
- UserForm: ユーザー作成・編集
- UserProfile: プロフィール表示

#### 5.3.3 アイテム管理
- ItemList: アイテム一覧表示
- ItemForm: アイテム作成・編集
- ItemDetail: アイテム詳細表示

### 5.4 状態管理
- React Query: サーバー状態管理
- Context API: アプリケーション状態
- カスタムフック: 再利用可能なロジック

### 5.5 APIクライアント統合
- 自動生成TypeScriptクライアント
- 型安全なAPI呼び出し
- エラーハンドリング統合

### 5.6 テスト
#### 5.6.1 E2Eテスト（Playwright）
```bash
# テスト実行
npm run test:e2e

# テストレポート生成
npm run test:e2e:report
```

#### 5.6.2 単体テスト（Jest）
- コンポーネントテスト
- カスタムフックテスト
- ユーティリティ関数テスト

### 5.7 ビルドと最適化
- Viteによる高速ビルド
- コード分割
- レスポンシブデザイン
- パフォーマンス最適化

### 5.8 開発環境
```bash
# 依存関係インストール
npm install

# 開発サーバー起動
npm run dev

# 本番ビルド
npm run build

# テスト実行
npm run test
```

### 5.9 セキュリティ対策
- CSRF対策
- XSS対策
- 認証状態管理
- 入力バリデーション

## 6. CI/CDとデプロイ

本システムは、GitHub ActionsによるCI/CD、Docker Composeによるコンテナ管理、Traefikによるリバースプロキシを採用し、効率的な開発・デプロイメントフローを実現しています。

### 6.1 CI/CD（GitHub Actions）
#### 6.1.1 ワークフロー構成
- 場所: `.github/workflows/`
- トリガー: プッシュ、プルリクエスト
- 環境: Ubuntu最新版

#### 6.1.2 主要ジョブ
```yaml
jobs:
  test-backend:
    - バックエンドテスト実行
    - コードリント
    - 型チェック
  
  test-frontend:
    - フロントエンドビルド
    - E2Eテスト (Playwright)
    - 型チェック

  deploy:
    - Docker イメージビルド
    - コンテナレジストリへのプッシュ
    - 本番環境デプロイ
```

### 6.2 Docker Compose構成
#### 6.2.1 開発環境
```bash
# 開発環境起動
docker compose up -d

# サービス確認
docker compose ps

# ログ確認
docker compose logs -f
```

#### 6.2.2 本番環境
```bash
# 本番環境起動
docker compose -f docker-compose.yml -f docker-compose.traefik.yml up -d

# SSL証明書更新
docker compose exec traefik certbot renew
```

### 6.3 コンテナ構成
- frontend: Reactアプリケーション
- backend: FastAPIサーバー
- db: PostgreSQLデータベース
- traefik: リバースプロキシ
- mailcatcher: 開発用メールサーバー
- adminer: データベース管理UI

### 6.4 Traefik設定
#### 6.4.1 主要機能
- 自動HTTPS対応
- Let's Encrypt統合
- サービスディスカバリ
- ヘルスチェック

#### 6.4.2 設定ファイル
- `docker-compose.traefik.yml`
- `traefik.toml`
- `acme.json`（SSL証明書）

### 6.5 環境変数管理
#### 6.5.1 開発環境
- `.env`ファイル
- `docker-compose.override.yml`

#### 6.5.2 本番環境
- 環境変数
- シークレット管理
- 証明書管理

### 6.6 デプロイメントフロー
1. GitHub Actionsによるテスト実行
2. Dockerイメージのビルドと更新
3. コンテナの再起動
4. ヘルスチェック確認
5. ロールバック手順（必要時）

### 6.7 モニタリング
- コンテナヘルスチェック
- ログ集約
- メトリクス収集
- アラート設定

### 6.8 バックアップ戦略
- データベースバックアップ
- 設定ファイルバックアップ
- 復旧手順書

### 6.9 スケーリング
- 水平スケーリング対応
- ロードバランシング設定
- セッション管理
- キャッシュ戦略

## 7. メンテナンスや将来の拡張

本システムは、将来的な機能拡張やメンテナンス性を考慮した設計となっています。以下に、推奨される拡張案と保守性向上のための提案をまとめます。

### 7.1 主要機能・責務
- システムの継続的な改善と拡張
- 新機能の追加とレガシーコードの管理
- パフォーマンスとスケーラビリティの最適化
- セキュリティとコンプライアンスの維持

### 7.2 使用技術
#### 現行技術スタック
- バックエンド: FastAPI, SQLModel, PostgreSQL
- フロントエンド: React, TypeScript, Chakra UI
- インフラ: Docker, Traefik, GitHub Actions

#### 将来検討技術
```python
# キャッシュレイヤー導入例 (/backend/app/core/cache.py)
from redis import Redis
from fastapi import Depends

async def get_cache() -> Redis:
    return Redis(host='redis', port=6379, decode_responses=True)

# 使用例
@router.get("/items/{item_id}")
async def get_item(item_id: int, cache: Redis = Depends(get_cache)):
    if cached := await cache.get(f"item:{item_id}"):
        return json.loads(cached)
```

### 7.3 関連ファイル・ディレクトリ
- `/backend/app/`: バックエンドコア機能
- `/frontend/src/`: フロントエンドアプリケーション
- `/docs/`: プロジェクトドキュメント
- `/scripts/`: 運用・保守スクリプト
- `/.github/workflows/`: CI/CD設定

### 7.4 注意点や設定ファイル
- `docker-compose.yml`: サービス構成管理
- `.env`: 環境変数設定
- `alembic/`: データベースマイグレーション
- `pyproject.toml`: Pythonプロジェクト設定
- `package.json`: Node.jsプロジェクト設定

### 7.5 機能拡張案
#### 7.5.1 認証・認可
- OAuth2.0プロバイダー統合
- 二要素認証（2FA）
- ロールベースアクセス制御（RBAC）
- シングルサインオン（SSO）

#### 7.5.2 データ管理
- 高度な検索機能
- データエクスポート/インポート
- バッチ処理機能
- アーカイブ機能

#### 7.5.3 UI/UX
- ダークモード対応
- モバイルアプリ対応
- オフライン対応
- アクセシビリティ改善

### 7.6 技術的改善案
#### 7.6.1 バックエンド
- キャッシュレイヤーの追加（Redis）
- メッセージキューの導入（RabbitMQ）
- GraphQL APIの提供
- WebSocket対応

#### 7.6.2 フロントエンド
- マイクロフロントエンド化
- PWA対応
- パフォーマンス最適化
- 状態管理の改善

#### 7.6.3 インフラストラクチャ
- Kubernetes移行
- CDN導入
- 地理分散化
- 自動スケーリング

### 7.7 保守性向上
#### 7.7.1 モニタリング強化
- APM（Application Performance Monitoring）
- ログ分析
- エラートラッキング
- ユーザー行動分析

#### 7.7.2 テスト強化
- プロパティベーステスト
- パフォーマンステスト
- セキュリティテスト
- カオスエンジニアリング

#### 7.7.3 ドキュメント整備
- API仕様書の自動更新
- アーキテクチャ図の管理
- 運用手順書の整備
- トラブルシューティングガイド

### 7.8 推奨される実装順序
1. セキュリティ強化（優先度：高）
   - 認証システムの強化
   - 脆弱性対策
2. モニタリング強化（優先度：高）
   - ログ集約システム導入
   - アラート設定
3. パフォーマンス最適化（優先度：中）
   - キャッシュ導入
   - クエリ最適化
4. 機能拡張（優先度：中）
   - UI/UX改善
   - 新機能追加
5. インフラ改善（優先度：低）
   - コンテナ化完了
   - クラウドネイティブ化
